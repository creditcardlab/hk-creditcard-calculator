# Worktree Plan: Notion Overrides + Review Workflow (Bidirectional-ish)

Goal: make Notion useful for **visualizing + reviewing** repo data, and allow **safe ‚Äúbidirectional updates‚Äù** by pulling back a small, controlled set of fields into the repo **without directly editing core data files**.

Non-goals:
- Notion is **not** the source of truth for reward logic / rates / counters (for now).
- We are **not** building the ‚ÄúAI reads T&C and auto-updates DB‚Äù pipeline in this worktree (that‚Äôs next track).

## Current State (Main)
- `tools/sync_notion.py` supports:
  - `--page-url <notion page>` (push repo ‚Üí Notion)
  - `--bootstrap` (create missing child DBs under the page)
- Child DBs created/ensured today:
  - Cards, Categories, Modules, Trackers, Conversions
  - Campaigns, Campaign Sections, Campaign Registry
  - Counters Registry
- `DATA` is built in `js/data_index.js` and exported as `window.DATA`.

## Design: ‚ÄúBidirectional‚Äù Via Overrides File
We only allow Notion ‚Üí repo updates for a whitelist of ‚Äúpresentation + verification metadata‚Äù fields.

### Why
- You can unify naming/unit/warnings in one place.
- You can maintain ‚Äúlast verified‚Äù + ‚Äúsource URL‚Äù without touching logic.
- It avoids destroying core structure with accidental Notion edits.

### New Repo File (generated)
Create a committed file `js/data_notion_overrides.js`:

```js
// js/data_notion_overrides.js
// Generated by tools/sync_notion.py --pull-overrides
// Only contains whitelisted fields. Core reward logic stays in js/data_*.js.

const NOTION_OVERRIDES = {
  version: 1,
  cards: {
    // key = card id (e.g. "hsbc_everymile")
    // fields are optional; omitted means ‚Äúno override‚Äù
    "hsbc_everymile": {
      display_name_zhhk: "",
      note_zhhk: "",
      status: "active",               // active|expired|unknown
      last_verified_at: "2026-02-04",  // YYYY-MM-DD
      source_url: "",
      source_title: "",
    }
  },
  modules: {
    // key = module key (e.g. "em_overseas_bonus")
    "em_overseas_bonus": {
      display_name_zhhk: "",
      note_zhhk: "",
      status: "active",
      last_verified_at: "",
      source_url: "",
      source_title: "",
      unit_override: "$",             // optional override for mission/progress display
    }
  },
  campaigns: {
    // key = campaign id (e.g. "em_promo")
    "em_promo": {
      display_name_zhhk: "",
      note_zhhk: "",
      status: "active",
      last_verified_at: "",
      source_url: "",
      source_title: "",
    }
  },
  campaignSections: {
    // key = section id = `${campaignId}#${1-based index}` (matches sync_notion.py)
    "em_promo#1": {
      label_zhhk: "üéØ Á∞ΩË≥¨‰ªªÂãôÈÄ≤Â∫¶"
    }
  },
  conversions: {
    // key = conversion src (e.g. "CITI_PM_PTS")
    "CITI_PM_PTS": {
      note_zhhk: "",
      last_verified_at: "",
      source_url: "",
      source_title: "",
    }
  }
};
```

Notes:
- Keep emoji (user preference).
- `unit_override` default should remain `$` for mission; reward unit should still follow card reward unit unless explicitly overridden.

### Apply Overrides At Runtime
Update `js/data_index.js`:
- After `const data = { ... }` is built, and before `root.DATA = data`:
  - if `typeof NOTION_OVERRIDES !== "undefined"` ‚Üí apply

Implementation rules:
- Cards: match by `card.id`
- Modules/Trackers/Categories: match by object key
- Campaigns: match by `campaign.id`
- Campaign sections: match by `${campaignId}#${i}`
- Conversions: match by `conversion.src`
- Only apply known keys; ignore unknown keys (forward compatible).

No behavior changes to calculation logic; overrides are ‚Äúpresentation + metadata‚Äù only.

## Notion Schema (Minimum)
We keep existing DB titles and title properties (stable upsert keys), and add a consistent ‚Äúreview + sync‚Äù layer.

### Add These Properties (same names across DBs)
- `Display Name (zh-HK)` (rich_text)
- `Note (zh-HK)` (rich_text)
- `Status` (select: `active`, `expired`, `unknown`)
- `Last Verified` (date)
- `Source URL` (url)
- `Source Title` (rich_text)
- `Sync To Repo` (checkbox) ‚Äì approval gate

Where to add first (MVP):
- Cards, Modules, Campaigns, Conversions

Optional later:
- Campaign Sections (for label override)

## tools/sync_notion.py Changes

### CLI
Add:
- `--pull-overrides` (bool): pull Notion ‚Üí generate `js/data_notion_overrides.js`
- `--overrides-out <path>` (default `js/data_notion_overrides.js`)
- (optional) `--pull-db <name>` (repeatable) for limiting scope, e.g. only Cards/Modules
- (optional) `--ack` (bool): after successful pull, set `Sync To Repo` to false for pulled rows

### Pull Logic (deterministic)
For each supported DB:
1. Find child DB id by exact title (or legacy alias like current `pick_db_name`).
2. Query rows where `Sync To Repo == true`.
3. For each row:
   - Use the title property as the stable key (Card ID / Module Key / Campaign ID / Conversion Src).
   - Extract only whitelisted fields.
4. Write deterministic JS output:
   - stable key ordering
   - no timestamps

### Whitelist Mapping
Notion ‚Üí Overrides output fields:
- Display Name (zh-HK) ‚Üí `display_name_zhhk`
- Note (zh-HK) ‚Üí `note_zhhk`
- Status ‚Üí `status`
- Last Verified ‚Üí `last_verified_at` (convert to YYYY-MM-DD)
- Source URL ‚Üí `source_url`
- Source Title ‚Üí `source_title`
- Unit Override (optional future column) ‚Üí `unit_override`

### Safety
- If a DB is missing, print warning and continue.
- If property missing, treat as empty.
- Never write overrides that alter:
  - rates/caps/counter keys
  - eligibility logic

## UX / Operating Checklist (for user)
1. Run push to Notion (visualize):
   - `python3 tools/sync_notion.py --page-url "<page>" --bootstrap`
2. In Notion, edit only the review props above; mark `Sync To Repo` for the rows you approved.
3. Pull overrides back:
   - `python3 tools/sync_notion.py --page-url "<page>" --pull-overrides`
4. Commit changes (should be only `js/data_notion_overrides.js` + maybe `js/data_index.js` once).

## Extra (Nice-to-have)
- Add `.gitignore` entries: `__pycache__/`, `*.pyc` (avoid dirty status).
- Make `tools/report_data_quality.js` deterministic by removing timestamp line OR stop committing the report.

