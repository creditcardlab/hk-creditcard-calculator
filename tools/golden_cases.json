{
  "schemaVersion": 1,
  "cases": [
    {
      "id": "case_001_basic_general_cash",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2025-11-15",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "hsbc_red",
          "hsbc_everymile"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "hsbc_everymile",
        "topValue": 10,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_002_online_cash",
      "input": {
        "amount": 2000,
        "category": "general",
        "date": "2025-11-15",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "hsbc_red",
          "hsbc_vs"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "hsbc_red",
        "topValue": 80,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_003_online_partial_cap",
      "input": {
        "amount": 10000,
        "category": "general",
        "date": "2025-11-15",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "hsbc_red"
        ],
        "settings": {},
        "usage": {
          "red_online_bonus_cap": 350
        }
      },
      "expected": {
        "topCardId": "hsbc_red",
        "topValue": 50,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_004_online_capped",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2025-11-15",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "hsbc_red"
        ],
        "settings": {},
        "usage": {
          "red_online_bonus_cap": 360
        }
      },
      "expected": {
        "topCardId": "hsbc_red",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": true,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_005_dining_red_hot",
      "input": {
        "amount": 1500,
        "category": "dining",
        "date": "2025-11-15",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "hsbc_vs",
          "hsbc_red"
        ],
        "settings": {
          "red_hot_allocation": {
            "dining": 5,
            "world": 0,
            "home": 0,
            "enjoyment": 0,
            "style": 0
          }
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "hsbc_vs",
        "topValue": 6,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_005b_fastfood_aliases_to_dining_for_hsbc_red_hot",
      "input": {
        "amount": 1000,
        "category": "fastfood",
        "date": "2026-02-12",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "hsbc_vs"
        ],
        "settings": {
          "red_hot_rewards_enabled": true,
          "red_hot_allocation": {
            "dining": 5,
            "world": 0,
            "home": 0,
            "enjoyment": 0,
            "style": 0
          }
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "hsbc_vs",
        "topValue": 36,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_006_em_promo_locked",
      "input": {
        "amount": 3000,
        "category": "overseas_jkt",
        "date": "2025-12-15",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "hsbc_everymile"
        ],
        "settings": {
          "em_promo_enabled": true
        },
        "usage": {
          "em_q1_total": 5000
        }
      },
      "expected": {
        "topCardId": "hsbc_everymile",
        "topValue": 30,
        "breakdownFlags": {
          "hasLocked": true,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_007_em_promo_met",
      "input": {
        "amount": 3000,
        "category": "overseas_jkt",
        "date": "2025-12-15",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "hsbc_everymile"
        ],
        "settings": {
          "em_promo_enabled": true
        },
        "usage": {
          "em_q1_total": 13000
        }
      },
      "expected": {
        "topCardId": "hsbc_everymile",
        "topValue": 75,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_008_em_promo_capped",
      "input": {
        "amount": 3000,
        "category": "overseas_jkt",
        "date": "2025-12-15",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "hsbc_everymile"
        ],
        "settings": {
          "em_promo_enabled": true
        },
        "usage": {
          "em_q1_total": 13000,
          "em_promo_cap": 225
        }
      },
      "expected": {
        "topCardId": "hsbc_everymile",
        "topValue": 30,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": true,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_009_winter_accumulating",
      "input": {
        "amount": 1200,
        "category": "dining",
        "date": "2025-12-20",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "hsbc_red"
        ],
        "settings": {
          "winter_promo_enabled": true
        },
        "usage": {
          "winter_total": 5000,
          "winter_eligible": 5000
        }
      },
      "expected": {
        "topCardId": "hsbc_red",
        "topValue": 4.8,
        "breakdownFlags": {
          "hasLocked": true,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_010_winter_capped",
      "input": {
        "amount": 1200,
        "category": "dining",
        "date": "2025-12-20",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "hsbc_red"
        ],
        "settings": {
          "winter_promo_enabled": true
        },
        "usage": {
          "winter_total": 40000,
          "winter_eligible": 40000
        }
      },
      "expected": {
        "topCardId": "hsbc_red",
        "topValue": 4.8,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": true,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_011_citi_rewards_mobile_miles",
      "input": {
        "amount": 800,
        "category": "grocery",
        "date": "2025-11-10",
        "displayMode": "miles",
        "isOnline": false,
        "paymentMethod": "apple_pay",
        "ownedCards": [
          "citi_rewards",
          "hsbc_red"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "citi_rewards",
        "topValue": 144,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_012_citi_rewards_physical_miles",
      "input": {
        "amount": 800,
        "category": "grocery",
        "date": "2025-11-10",
        "displayMode": "miles",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "citi_rewards",
          "hsbc_red"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "citi_rewards",
        "topValue": 53.333333,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_013_overseas_cash_compete",
      "input": {
        "amount": 5000,
        "category": "overseas_tw",
        "date": "2025-10-05",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "sc_simply_cash",
          "hsbc_red"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "sc_simply_cash",
        "topValue": 100,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_014_deduct_fcf_ranking",
      "input": {
        "amount": 5000,
        "category": "overseas_other",
        "date": "2025-10-05",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "hsbc_red",
          "sc_smart"
        ],
        "settings": {
          "deduct_fcf_ranking": true
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "sc_smart",
        "topValue": 28,
        "breakdownFlags": {
          "hasLocked": true,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_015_travel_red_hot_custom",
      "input": {
        "amount": 2200,
        "category": "travel",
        "date": "2025-09-12",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "hsbc_vs"
        ],
        "settings": {
          "red_hot_allocation": {
            "dining": 5,
            "world": 0,
            "home": 0,
            "enjoyment": 3,
            "style": 0
          }
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "hsbc_vs",
        "topValue": 8.8,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_016_alipay_zero_reward",
      "input": {
        "amount": 500,
        "category": "alipay",
        "date": "2025-08-03",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "hsbc_red",
          "sc_simply_cash"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "sc_simply_cash",
        "topValue": 7.5,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_017_tuition_bonus",
      "input": {
        "amount": 10000,
        "category": "tuition",
        "date": "2025-08-20",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "hsbc_gold_student"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "hsbc_gold_student",
        "topValue": 40,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_018_tuition_capped",
      "input": {
        "amount": 1000,
        "category": "tuition",
        "date": "2025-08-20",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "hsbc_gold_student"
        ],
        "settings": {},
        "usage": {
          "student_tuition_cap": 8333
        }
      },
      "expected": {
        "topCardId": "hsbc_gold_student",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_019_overseas_miles",
      "input": {
        "amount": 3200,
        "category": "overseas_cn",
        "date": "2025-07-01",
        "displayMode": "miles",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "sc_cathay_std",
          "hsbc_everymile"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "sc_cathay_std",
        "topValue": 800,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_020_dining_miles",
      "input": {
        "amount": 900,
        "category": "dining",
        "date": "2025-07-01",
        "displayMode": "miles",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "sc_cathay_std",
          "hsbc_everymile"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "sc_cathay_std",
        "topValue": 225,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_020a_sc_cathay_cxuo_requires_merchant",
      "input": {
        "amount": 1000,
        "category": "cathay_hkexpress",
        "date": "2026-02-12",
        "displayMode": "miles",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "sc_cathay_std"
        ],
        "settings": {},
        "usage": {
          "sc_cathay_cxuo_spend": 8000
        }
      },
      "expected": {
        "topCardId": "sc_cathay_std",
        "topValue": 166.666667,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_020b_sc_cathay_cxuo_cathay_merchant_bonus",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-02-12",
        "displayMode": "miles",
        "isOnline": false,
        "paymentMethod": "physical",
        "merchantId": "cathay_pacific",
        "ownedCards": [
          "sc_cathay_std"
        ],
        "settings": {},
        "usage": {
          "sc_cathay_cxuo_spend": 8000
        }
      },
      "expected": {
        "topCardId": "sc_cathay_std",
        "topValue": 500.041667,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_020c_sc_cathay_cxuo_hkexpress_merchant_bonus",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-02-12",
        "displayMode": "miles",
        "isOnline": false,
        "paymentMethod": "physical",
        "merchantId": "hk_express",
        "ownedCards": [
          "sc_cathay_std"
        ],
        "settings": {},
        "usage": {
          "sc_cathay_cxuo_spend": 8000
        }
      },
      "expected": {
        "topCardId": "sc_cathay_std",
        "topValue": 500.041667,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_020d_sc_cathay_overseas_offer_unregistered",
      "input": {
        "amount": 10000,
        "category": "overseas_jp",
        "date": "2026-02-21",
        "displayMode": "miles",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "sc_cathay_std"
        ],
        "settings": {
          "sc_cathay_overseas_spending_offer_enabled": false
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "sc_cathay_std",
        "topValue": 2500,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_020e_sc_cathay_overseas_offer_registered_unlock_same_tx",
      "input": {
        "amount": 10000,
        "category": "overseas_jp",
        "date": "2026-02-21",
        "displayMode": "miles",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "sc_cathay_std"
        ],
        "settings": {
          "sc_cathay_overseas_spending_offer_enabled": true
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "sc_cathay_std",
        "topValue": 5000,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_020f_sc_cathay_overseas_offer_bonus_capped",
      "input": {
        "amount": 2000,
        "category": "overseas_jp",
        "date": "2026-02-21",
        "displayMode": "miles",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "sc_cathay_std"
        ],
        "settings": {
          "sc_cathay_overseas_spending_offer_enabled": true
        },
        "usage": {
          "sc_cathay_overseas_spend_offer_spend": 10000,
          "sc_cathay_overseas_spend_offer_bonus_cap": 2500
        }
      },
      "expected": {
        "topCardId": "sc_cathay_std",
        "topValue": 500,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": true,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_021_cashback_cash",
      "input": {
        "amount": 1500,
        "category": "general",
        "date": "2025-06-18",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "citi_cashback",
          "sc_simply_cash"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "sc_simply_cash",
        "topValue": 22.5,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_022_transport_octopus",
      "input": {
        "amount": 600,
        "category": "transport",
        "date": "2025-06-18",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "citi_octopus",
          "hsbc_red"
        ],
        "settings": {},
        "usage": {
          "spend_citi_octopus": 6000
        }
      },
      "expected": {
        "topCardId": "citi_octopus",
        "topValue": 90,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_023_mmpower_locked",
      "input": {
        "amount": 2000,
        "category": "general",
        "date": "2025-05-08",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "hangseng_mmpower"
        ],
        "settings": {
          "mmpower_promo_enabled": true
        },
        "usage": {
          "spend_hangseng_mmpower": 0
        }
      },
      "expected": {
        "topCardId": "hangseng_mmpower",
        "topValue": 8,
        "breakdownFlags": {
          "hasLocked": true,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_024_mmpower_met",
      "input": {
        "amount": 2000,
        "category": "general",
        "date": "2025-05-08",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "hangseng_mmpower"
        ],
        "settings": {
          "mmpower_promo_enabled": true
        },
        "usage": {
          "spend_hangseng_mmpower": 6000
        }
      },
      "expected": {
        "topCardId": "hangseng_mmpower",
        "topValue": 100,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_025_travel_plus_locked",
      "input": {
        "amount": 2500,
        "category": "travel_plus_tier1",
        "date": "2026-04-02",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "hangseng_travel_plus"
        ],
        "settings": {
          "travel_plus_promo_enabled": true
        },
        "usage": {
          "spend_hangseng_travel_plus": 0
        }
      },
      "expected": {
        "topCardId": "hangseng_travel_plus",
        "topValue": 10,
        "breakdownFlags": {
          "hasLocked": true,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_026_travel_plus_tier1_mo_met",
      "input": {
        "amount": 2500,
        "date": "2026-05-01",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "hangseng_travel_plus"
        ],
        "settings": {
          "travel_plus_promo_enabled": true
        },
        "category": "overseas_mo",
        "usage": {
          "spend_hangseng_travel_plus": 8000
        }
      },
      "expected": {
        "topCardId": "hangseng_travel_plus",
        "topValue": 175,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_027_travel_plus_tier2_other_met",
      "input": {
        "amount": 2500,
        "date": "2026-05-01",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "hangseng_travel_plus"
        ],
        "settings": {
          "travel_plus_promo_enabled": true
        },
        "category": "overseas_other",
        "usage": {
          "spend_hangseng_travel_plus": 8000
        }
      },
      "expected": {
        "topCardId": "hangseng_travel_plus",
        "topValue": 125,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_028_travel_plus_tier1_mo_locked",
      "input": {
        "amount": 2500,
        "date": "2026-05-01",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "hangseng_travel_plus"
        ],
        "settings": {
          "travel_plus_promo_enabled": true
        },
        "category": "overseas_mo",
        "usage": {
          "spend_hangseng_travel_plus": 0
        }
      },
      "expected": {
        "topCardId": "hangseng_travel_plus",
        "topValue": 10,
        "breakdownFlags": {
          "hasLocked": true,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_029_red_hot_reward_cap_partial",
      "input": {
        "amount": 1000,
        "category": "dining",
        "date": "2026-02-01",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "hsbc_vs"
        ],
        "settings": {
          "red_hot_rewards_enabled": true,
          "red_hot_allocation": {
            "dining": 5,
            "world": 0,
            "home": 0,
            "enjoyment": 0,
            "style": 0
          }
        },
        "usage": {
          "red_hot_variable_cap": 1999
        }
      },
      "expected": {
        "topCardId": "hsbc_vs",
        "topValue": 17,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_030_red_hot_reward_cap_capped",
      "input": {
        "amount": 1000,
        "category": "dining",
        "date": "2026-02-01",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "hsbc_vs"
        ],
        "settings": {
          "red_hot_rewards_enabled": true,
          "red_hot_allocation": {
            "dining": 5,
            "world": 0,
            "home": 0,
            "enjoyment": 0,
            "style": 0
          }
        },
        "usage": {
          "red_hot_variable_cap": 2000
        }
      },
      "expected": {
        "topCardId": "hsbc_vs",
        "topValue": 16,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": true,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_031_sc_smart_designated_cap_overflow_fallback_basic",
      "input": {
        "amount": 2000,
        "category": "smart_designated",
        "date": "2026-01-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "sc_smart"
        ],
        "settings": {},
        "usage": {
          "sc_smart_monthly_eligible": 16000,
          "sc_smart_cap": 4500
        }
      },
      "expected": {
        "topCardId": "sc_smart",
        "topValue": 43,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_032_citi_cb_uk_eea_physical_excluded",
      "input": {
        "amount": 1000,
        "category": "overseas_uk_eea",
        "date": "2026-02-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "citi_cashback"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "citi_cashback",
        "topValue": 10,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_033_citi_cb_uk_eea_online_allowed",
      "input": {
        "amount": 1000,
        "category": "overseas_uk_eea",
        "date": "2026-02-10",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "citi_cashback"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "citi_cashback",
        "topValue": 20,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_034_citi_club_designated_under_cap",
      "input": {
        "amount": 1000,
        "category": "citi_club_merchant",
        "date": "2026-02-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "citi_club"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "citi_club",
        "topValue": 40,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_035_citi_club_designated_partial_cap",
      "input": {
        "amount": 1000,
        "category": "citi_club_merchant",
        "date": "2026-02-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "citi_club"
        ],
        "settings": {},
        "usage": {
          "citi_club_designated_bonus_cap": 1450
        }
      },
      "expected": {
        "topCardId": "citi_club",
        "topValue": 20,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_036_citi_club_designated_capped_fallback_base",
      "input": {
        "amount": 1000,
        "category": "citi_club_merchant",
        "date": "2026-02-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "citi_club"
        ],
        "settings": {},
        "usage": {
          "citi_club_designated_bonus_cap": 1500
        }
      },
      "expected": {
        "topCardId": "citi_club",
        "topValue": 10,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": true,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_037_citi_club_shopping_under_cap",
      "input": {
        "amount": 1000,
        "category": "club_shopping",
        "date": "2026-02-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "citi_club"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "citi_club",
        "topValue": 20,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_038_citi_club_shopping_capped_fallback_base",
      "input": {
        "amount": 1000,
        "category": "club_shopping",
        "date": "2026-02-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "citi_club"
        ],
        "settings": {},
        "usage": {
          "citi_club_shopping_bonus_cap": 500
        }
      },
      "expected": {
        "topCardId": "citi_club",
        "topValue": 10,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": true,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_039_citi_club_telecom_autopay_total_3pct",
      "input": {
        "amount": 1000,
        "category": "citi_club_telecom",
        "date": "2026-02-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "citi_club"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "citi_club",
        "topValue": 30,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_040_octopus_tunnel_split_5pct",
      "input": {
        "amount": 600,
        "category": "tunnel",
        "date": "2025-06-18",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "citi_octopus",
          "hsbc_red"
        ],
        "settings": {},
        "usage": {
          "spend_citi_octopus": 12000
        }
      },
      "expected": {
        "topCardId": "citi_octopus",
        "topValue": 30,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_041_octopus_tunnel_capped_fallback_base",
      "input": {
        "amount": 1000,
        "category": "tunnel",
        "date": "2025-06-18",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "citi_octopus"
        ],
        "settings": {},
        "usage": {
          "spend_citi_octopus": 12000,
          "citi_octopus_reward_cap": 500
        }
      },
      "expected": {
        "topCardId": "citi_octopus",
        "topValue": 5,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": true,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_042_octopus_transport_locked_below_threshold",
      "input": {
        "amount": 600,
        "category": "transport",
        "date": "2025-06-18",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "citi_octopus",
          "hsbc_red"
        ],
        "settings": {},
        "usage": {
          "spend_citi_octopus": 0
        }
      },
      "expected": {
        "topCardId": "citi_octopus",
        "topValue": 3,
        "breakdownFlags": {
          "hasLocked": true,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_043_octopus_transport_tier2_cap500_partial",
      "input": {
        "amount": 1000,
        "category": "transport",
        "date": "2025-06-18",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "citi_octopus"
        ],
        "settings": {},
        "usage": {
          "spend_citi_octopus": 12000,
          "citi_octopus_reward_cap": 450
        }
      },
      "expected": {
        "topCardId": "citi_octopus",
        "topValue": 50,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_044_citi_rewards_shopping_mobile_higher_only",
      "input": {
        "amount": 800,
        "category": "apparel",
        "date": "2025-11-10",
        "displayMode": "miles",
        "isOnline": false,
        "paymentMethod": "apple_pay",
        "ownedCards": [
          "citi_rewards"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "citi_rewards",
        "topValue": 432,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_045_citi_rewards_bonus_cap_partial",
      "input": {
        "amount": 1000,
        "category": "entertainment",
        "date": "2025-11-10",
        "displayMode": "miles",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "citi_rewards"
        ],
        "settings": {},
        "usage": {
          "citi_rewards_bonus_cap": 113300
        }
      },
      "expected": {
        "topCardId": "citi_rewards",
        "topValue": 73.333333,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_046_citi_prestige_default_no_annual_bonus",
      "input": {
        "amount": 1200,
        "category": "general",
        "date": "2025-11-10",
        "displayMode": "miles",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "citi_prestige"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "citi_prestige",
        "topValue": 200,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_047_citi_prestige_bonus_wealth_year10_local",
      "input": {
        "amount": 1200,
        "category": "general",
        "date": "2025-11-10",
        "displayMode": "miles",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "citi_prestige"
        ],
        "settings": {
          "citi_prestige_bonus_enabled": true,
          "citi_prestige_tenure_years": 10,
          "citi_prestige_wealth_client": true
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "citi_prestige",
        "topValue": 230,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_048_citi_prestige_bonus_wealth_year10_overseas",
      "input": {
        "amount": 1200,
        "category": "overseas_other",
        "date": "2025-11-10",
        "displayMode": "miles",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "citi_prestige"
        ],
        "settings": {
          "citi_prestige_bonus_enabled": true,
          "citi_prestige_tenure_years": 10,
          "citi_prestige_wealth_client": true
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "citi_prestige",
        "topValue": 330,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_049_hangseng_enjoy_4x_enabled",
      "input": {
        "amount": 1000,
        "category": "enjoy_4x",
        "date": "2025-11-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "hangseng_enjoy"
        ],
        "settings": {
          "hangseng_enjoy_points4x_enabled": true
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "hangseng_enjoy",
        "topValue": 20,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_050_hangseng_enjoy_4x_disabled_fallback_base",
      "input": {
        "amount": 1000,
        "category": "enjoy_4x",
        "date": "2025-11-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "hangseng_enjoy"
        ],
        "settings": {
          "hangseng_enjoy_points4x_enabled": false
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "hangseng_enjoy",
        "topValue": 5,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_051_hangseng_enjoy_legacy_dining_compatible",
      "input": {
        "amount": 1000,
        "category": "dining_enjoy",
        "date": "2025-11-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "hangseng_enjoy"
        ],
        "settings": {
          "hangseng_enjoy_points4x_enabled": true
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "hangseng_enjoy",
        "topValue": 20,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_052_mmpower_selected_category_enabled",
      "input": {
        "amount": 1000,
        "category": "electronics",
        "date": "2025-11-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "hangseng_mmpower"
        ],
        "settings": {
          "mmpower_promo_enabled": true,
          "mmpower_selected_categories": [
            "dining",
            "electronics"
          ]
        },
        "usage": {
          "spend_hangseng_mmpower": 6000
        }
      },
      "expected": {
        "topCardId": "hangseng_mmpower",
        "topValue": 10,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_053_mmpower_unselected_category_base_only",
      "input": {
        "amount": 1000,
        "category": "entertainment",
        "date": "2025-11-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "hangseng_mmpower"
        ],
        "settings": {
          "mmpower_promo_enabled": true,
          "mmpower_selected_categories": [
            "dining",
            "electronics"
          ]
        },
        "usage": {
          "spend_hangseng_mmpower": 6000
        }
      },
      "expected": {
        "topCardId": "hangseng_mmpower",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_054_mmpower_fastfood_excluded_from_selected_dining",
      "input": {
        "amount": 1000,
        "category": "fastfood",
        "date": "2025-11-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "hangseng_mmpower"
        ],
        "settings": {
          "mmpower_promo_enabled": true,
          "mmpower_selected_categories": [
            "dining",
            "electronics"
          ]
        },
        "usage": {
          "spend_hangseng_mmpower": 6000
        }
      },
      "expected": {
        "topCardId": "hangseng_mmpower",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_055_mmpower_online_foreign_no_double_count",
      "input": {
        "amount": 2000,
        "category": "overseas_other",
        "date": "2025-11-10",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "hangseng_mmpower"
        ],
        "settings": {
          "mmpower_promo_enabled": true
        },
        "usage": {
          "spend_hangseng_mmpower": 6000
        }
      },
      "expected": {
        "topCardId": "hangseng_mmpower",
        "topValue": 100,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_056_mmpower_online_selected_no_double_count",
      "input": {
        "amount": 2000,
        "category": "entertainment",
        "date": "2025-11-10",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "hangseng_mmpower"
        ],
        "settings": {
          "mmpower_promo_enabled": true,
          "mmpower_selected_categories": [
            "entertainment",
            "dining"
          ]
        },
        "usage": {
          "spend_hangseng_mmpower": 6000
        }
      },
      "expected": {
        "topCardId": "hangseng_mmpower",
        "topValue": 100,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_057_travel_plus_online_foreign_no_bonus",
      "input": {
        "amount": 2500,
        "category": "overseas_jkt",
        "date": "2026-06-10",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "hangseng_travel_plus"
        ],
        "settings": {
          "travel_plus_promo_enabled": true
        },
        "usage": {
          "spend_hangseng_travel_plus": 8000
        }
      },
      "expected": {
        "topCardId": "hangseng_travel_plus",
        "topValue": 10,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_058_travel_plus_outside_2026_window",
      "input": {
        "amount": 2500,
        "category": "overseas_mo",
        "date": "2027-01-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "hangseng_travel_plus"
        ],
        "settings": {
          "travel_plus_promo_enabled": true
        },
        "usage": {
          "spend_hangseng_travel_plus": 8000
        }
      },
      "expected": {
        "topCardId": "hangseng_travel_plus",
        "topValue": 10,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_059_dbs_black_overseas_locked_below_mission",
      "input": {
        "amount": 2000,
        "category": "overseas_other",
        "date": "2026-02-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "dbs_black"
        ],
        "settings": {
          "dbs_black_promo_enabled": true
        },
        "usage": {
          "spend_dbs_black_qual": 17000
        }
      },
      "expected": {
        "topCardId": "dbs_black",
        "topValue": 24,
        "breakdownFlags": {
          "hasLocked": true,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_060_dbs_black_overseas_promo_met",
      "input": {
        "amount": 2000,
        "category": "overseas_other",
        "date": "2026-02-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "dbs_black"
        ],
        "settings": {
          "dbs_black_promo_enabled": true
        },
        "usage": {
          "spend_dbs_black_qual": 20000
        }
      },
      "expected": {
        "topCardId": "dbs_black",
        "topValue": 48,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_061_dbs_black_overseas_bonus_monthly_cap_partial",
      "input": {
        "amount": 2000,
        "category": "overseas_other",
        "date": "2026-02-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "dbs_black"
        ],
        "settings": {
          "dbs_black_promo_enabled": true
        },
        "usage": {
          "spend_dbs_black_qual": 60000,
          "dbs_black_bonus_cap_monthly": 230
        }
      },
      "expected": {
        "topCardId": "dbs_black",
        "topValue": 34,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_062_dbs_black_ewallet_only_counts_first_5k_for_mission",
      "input": {
        "amount": 2000,
        "category": "overseas_other",
        "date": "2026-02-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "apple_pay",
        "ownedCards": [
          "dbs_black"
        ],
        "settings": {
          "dbs_black_promo_enabled": true
        },
        "usage": {
          "spend_dbs_black_qual": 18500,
          "spend_dbs_black_ewallet_qual": 4500
        }
      },
      "expected": {
        "topCardId": "dbs_black",
        "topValue": 24,
        "breakdownFlags": {
          "hasLocked": true,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_063_dbs_eminent_designated_5pct",
      "input": {
        "amount": 1000,
        "category": "dining",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "dbs_eminent"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "dbs_eminent",
        "topValue": 50,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_064_dbs_eminent_designated_below_300_falls_to_1pct",
      "input": {
        "amount": 200,
        "category": "dining",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "dbs_eminent"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "dbs_eminent",
        "topValue": 2,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_065_dbs_eminent_other_bonus_cap_partial",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "dbs_eminent"
        ],
        "settings": {},
        "usage": {
          "dbs_eminent_base_cap": 19900
        }
      },
      "expected": {
        "topCardId": "dbs_eminent",
        "topValue": 4.6,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_066_dbs_eminent_designated_cap_exceeded_base_only",
      "input": {
        "amount": 1000,
        "category": "dining",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "dbs_eminent"
        ],
        "settings": {},
        "usage": {
          "dbs_eminent_bonus_cap": 8000
        }
      },
      "expected": {
        "topCardId": "dbs_eminent",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": true,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_067_dbs_eminent_platinum_designated_5pct",
      "input": {
        "amount": 1000,
        "category": "dining",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "dbs_eminent_platinum"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "dbs_eminent_platinum",
        "topValue": 50,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_068_dbs_eminent_platinum_designated_cap_partial",
      "input": {
        "amount": 1000,
        "category": "dining",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "dbs_eminent_platinum"
        ],
        "settings": {},
        "usage": {
          "dbs_eminent_bonus_cap_platinum": 3980
        }
      },
      "expected": {
        "topCardId": "dbs_eminent_platinum",
        "topValue": 4.92,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_069_dbs_eminent_platinum_other_cap_partial",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "dbs_eminent_platinum"
        ],
        "settings": {},
        "usage": {
          "dbs_eminent_base_cap_platinum": 14950
        }
      },
      "expected": {
        "topCardId": "dbs_eminent_platinum",
        "topValue": 4.3,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_070_dbs_compass_superwed_eligible",
      "input": {
        "amount": 500,
        "category": "grocery",
        "date": "2026-02-11",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "dbs_compass"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "dbs_compass",
        "topValue": 40,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_071_dbs_compass_superwed_non_wed_fallback_base",
      "input": {
        "amount": 500,
        "category": "grocery",
        "date": "2026-02-12",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "dbs_compass"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "dbs_compass",
        "topValue": 2,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_072_dbs_compass_superwed_below_min_spend",
      "input": {
        "amount": 299,
        "category": "grocery",
        "date": "2026-02-11",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "dbs_compass"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "dbs_compass",
        "topValue": 1.196,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_073_dbs_compass_superwed_monthly_cap_partial",
      "input": {
        "amount": 300,
        "category": "grocery",
        "date": "2026-02-11",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "dbs_compass"
        ],
        "settings": {},
        "usage": {
          "dbs_compass_superwed_cap": 1900
        }
      },
      "expected": {
        "topCardId": "dbs_compass",
        "topValue": 8.8,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_074_dbs_compass_superwed_outside_window",
      "input": {
        "amount": 500,
        "category": "grocery",
        "date": "2026-06-03",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "dbs_compass"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "dbs_compass",
        "topValue": 2,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_075_dbs_compass_com_ewallet_bonus_cap_partial",
      "input": {
        "amount": 10000,
        "category": "alipay",
        "date": "2026-03-11",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "dbs_compass"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "dbs_compass",
        "topValue": 240,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_076_dbs_compass_com_ewallet_outside_window",
      "input": {
        "amount": 1000,
        "category": "alipay",
        "date": "2026-07-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "dbs_compass"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "dbs_compass",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_077_dbs_live_fresh_selected_online_54pct",
      "input": {
        "amount": 1000,
        "category": "travel",
        "date": "2026-03-12",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "dbs_live_fresh"
        ],
        "settings": {
          "live_fresh_pref": "travel"
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "dbs_live_fresh",
        "topValue": 54,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_078_dbs_live_fresh_selected_offline_base_only",
      "input": {
        "amount": 1000,
        "category": "travel",
        "date": "2026-03-12",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "dbs_live_fresh"
        ],
        "settings": {
          "live_fresh_pref": "travel"
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "dbs_live_fresh",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_079_dbs_live_fresh_online_foreign_with_selected_6pct",
      "input": {
        "amount": 1000,
        "category": "overseas_other",
        "date": "2026-03-12",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "dbs_live_fresh"
        ],
        "settings": {
          "live_fresh_pref": "online_foreign"
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "dbs_live_fresh",
        "topValue": 60,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_080_dbs_live_fresh_online_foreign_without_selected",
      "input": {
        "amount": 1000,
        "category": "overseas_other",
        "date": "2026-03-12",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "dbs_live_fresh"
        ],
        "settings": {
          "live_fresh_pref": "travel"
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "dbs_live_fresh",
        "topValue": 10,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_081_dbs_live_fresh_selected_cap_partial",
      "input": {
        "amount": 1000,
        "category": "travel",
        "date": "2026-03-12",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "dbs_live_fresh"
        ],
        "settings": {
          "live_fresh_pref": "travel"
        },
        "usage": {
          "dbs_live_fresh_cap": 195
        }
      },
      "expected": {
        "topCardId": "dbs_live_fresh",
        "topValue": 9,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_082_dbs_live_fresh_selected_outside_window",
      "input": {
        "amount": 1000,
        "category": "travel",
        "date": "2026-07-05",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "dbs_live_fresh"
        ],
        "settings": {
          "live_fresh_pref": "travel"
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "dbs_live_fresh",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_083_dbs_live_fresh_online_foreign_outside_window",
      "input": {
        "amount": 1000,
        "category": "overseas_other",
        "date": "2027-01-05",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "dbs_live_fresh"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "dbs_live_fresh",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_084_boc_cheers_vi_dining_locked_below_mission",
      "input": {
        "amount": 3000,
        "category": "dining",
        "date": "2026-03-15",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "boc_cheers_vi"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "boc_cheers_vi",
        "topValue": 12,
        "breakdownFlags": {
          "hasLocked": true,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_085_boc_cheers_vi_dining_mission_met",
      "input": {
        "amount": 1000,
        "category": "dining",
        "date": "2026-03-15",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "boc_cheers_vi"
        ],
        "settings": {},
        "usage": {
          "spend_boc_cheers_vi_qual": 5000
        }
      },
      "expected": {
        "topCardId": "boc_cheers_vi",
        "topValue": 40,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_086_boc_cheers_vi_fx_cap_partial",
      "input": {
        "amount": 1000,
        "category": "overseas_other",
        "date": "2026-03-15",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "boc_cheers_vi"
        ],
        "settings": {},
        "usage": {
          "spend_boc_cheers_vi_qual": 5000,
          "boc_cheers_travel_cap": 249500
        }
      },
      "expected": {
        "topCardId": "boc_cheers_vi",
        "topValue": 2,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_087_boc_cheers_vs_dining_mission_met",
      "input": {
        "amount": 1000,
        "category": "dining",
        "date": "2026-03-15",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "boc_cheers_vs"
        ],
        "settings": {},
        "usage": {
          "spend_boc_cheers_vs_qual": 5000
        }
      },
      "expected": {
        "topCardId": "boc_cheers_vs",
        "topValue": 32,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_088_boc_cheers_vi_total_cap_reached",
      "input": {
        "amount": 1000,
        "category": "dining",
        "date": "2026-03-15",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "boc_cheers_vi"
        ],
        "settings": {},
        "usage": {
          "spend_boc_cheers_vi_qual": 5000,
          "boc_cheers_total_cap_vi": 300000
        }
      },
      "expected": {
        "topCardId": "boc_cheers_vi",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": true,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_089_boc_cheers_vi_omycard_not_eligible_for_mission",
      "input": {
        "amount": 6000,
        "category": "dining",
        "date": "2026-03-15",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "omycard",
        "ownedCards": [
          "boc_cheers_vi"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "boc_cheers_vi",
        "topValue": 24,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_090_boc_cheers_vi_unlocks_with_current_tx",
      "input": {
        "amount": 6000,
        "category": "dining",
        "date": "2026-03-15",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "boc_cheers_vi"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "boc_cheers_vi",
        "topValue": 240,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_091_boc_cheers_vi_outside_promo_window",
      "input": {
        "amount": 1000,
        "category": "dining",
        "date": "2026-07-15",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "boc_cheers_vi"
        ],
        "settings": {},
        "usage": {
          "spend_boc_cheers_vi_qual": 5000
        }
      },
      "expected": {
        "topCardId": "boc_cheers_vi",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_092_boc_amazing_vi_weekday_bonus_with_mission",
      "input": {
        "amount": 1000,
        "category": "dining",
        "date": "2026-03-16",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "boc_cheers_vi"
        ],
        "settings": {
          "boc_amazing_enabled": true
        },
        "usage": {
          "spend_boc_cheers_vi_qual": 5000,
          "spend_boc_amazing_local": 5000
        }
      },
      "expected": {
        "topCardId": "boc_cheers_vi",
        "topValue": 60,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_093_boc_amazing_vi_online_red_day_bonus",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-03-15",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "boc_cheers_vi"
        ],
        "settings": {
          "boc_amazing_enabled": true
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "boc_cheers_vi",
        "topValue": 54,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_094_boc_amazing_fly_cn_locked_below_threshold",
      "input": {
        "amount": 1000,
        "category": "overseas_cn",
        "date": "2026-03-16",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "boc_cheers_vi"
        ],
        "settings": {
          "boc_amazing_enabled": true
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "boc_cheers_vi",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": true,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_095_boc_amazing_fly_cn_unlocked",
      "input": {
        "amount": 1000,
        "category": "overseas_cn",
        "date": "2026-03-16",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "boc_cheers_vi"
        ],
        "settings": {
          "boc_amazing_enabled": true
        },
        "usage": {
          "spend_boc_cheers_vi_qual": 5000,
          "spend_boc_fly_cn_stage": 5000
        }
      },
      "expected": {
        "topCardId": "boc_cheers_vi",
        "topValue": 100,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_096_boc_amazing_fly_cn_min_single_spend_500",
      "input": {
        "amount": 400,
        "category": "overseas_cn",
        "date": "2026-03-16",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "boc_cheers_vi"
        ],
        "settings": {
          "boc_amazing_enabled": true
        },
        "usage": {
          "spend_boc_cheers_vi_qual": 5000,
          "spend_boc_fly_cn_stage": 5000
        }
      },
      "expected": {
        "topCardId": "boc_cheers_vi",
        "topValue": 16,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_097_boc_amazing_shared_progress_unlocks_vs",
      "input": {
        "amount": 1000,
        "category": "dining",
        "date": "2026-03-16",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "boc_cheers_vi",
          "boc_cheers_vs"
        ],
        "settings": {
          "boc_amazing_enabled": true
        },
        "usage": {
          "spend_boc_amazing_local": 5000,
          "spend_boc_cheers_vs_qual": 5000
        }
      },
      "expected": {
        "topCardId": "boc_cheers_vs",
        "topValue": 52,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_098_boc_chill_base_only",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "boc_chill"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "boc_chill",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_099_boc_chill_online_bonus",
      "input": {
        "amount": 1000,
        "category": "online",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "boc_chill"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "boc_chill",
        "topValue": 54,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_100_boc_chill_merchant_locked_below_mission",
      "input": {
        "amount": 1000,
        "category": "chill_merchant",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "boc_chill"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "boc_chill",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": true,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_101_boc_chill_merchant_unlocked",
      "input": {
        "amount": 1000,
        "category": "chill_merchant",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "boc_chill"
        ],
        "settings": {},
        "usage": {
          "spend_boc_chill_monthly": 1500
        }
      },
      "expected": {
        "topCardId": "boc_chill",
        "topValue": 104,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_102_boc_chill_bonus_cap_partial",
      "input": {
        "amount": 1000,
        "category": "online",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "boc_chill"
        ],
        "settings": {},
        "usage": {
          "boc_chill_bonus_cap_2026": 37000
        }
      },
      "expected": {
        "topCardId": "boc_chill",
        "topValue": 6,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_103_boc_go_base_only",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "boc_go_diamond"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "boc_go_diamond",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_104_boc_go_merchant_bonus",
      "input": {
        "amount": 1000,
        "category": "go_merchant",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "boc_go_diamond"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "boc_go_diamond",
        "topValue": 50,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_105_boc_go_mobile_bonus",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "apple_pay",
        "ownedCards": [
          "boc_go_diamond"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "boc_go_diamond",
        "topValue": 12,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_106_boc_go_overseas_bonus_physical",
      "input": {
        "amount": 1000,
        "category": "overseas_other",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "boc_go_diamond"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "boc_go_diamond",
        "topValue": 8,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_107_boc_go_overseas_mobile_prefers_mobile_bonus",
      "input": {
        "amount": 1000,
        "category": "overseas_other",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "apple_pay",
        "ownedCards": [
          "boc_go_diamond"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "boc_go_diamond",
        "topValue": 12,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_108_boc_go_merchant_bonus_cap_partial",
      "input": {
        "amount": 1000,
        "category": "go_merchant",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "boc_go_diamond"
        ],
        "settings": {},
        "usage": {
          "boc_go_merchant_bonus_cap_2026": 24900
        }
      },
      "expected": {
        "topCardId": "boc_go_diamond",
        "topValue": 4.4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_109_boc_go_merchant_outside_window",
      "input": {
        "amount": 1000,
        "category": "go_merchant",
        "date": "2026-07-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "boc_go_diamond"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "boc_go_diamond",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_110_boc_go_platinum_base_only",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "boc_go_platinum"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "boc_go_platinum",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_111_boc_go_platinum_merchant_locked",
      "input": {
        "amount": 500,
        "category": "go_merchant",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "boc_go_platinum"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "boc_go_platinum",
        "topValue": 2,
        "breakdownFlags": {
          "hasLocked": true,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_112_boc_go_platinum_merchant_unlocked",
      "input": {
        "amount": 1000,
        "category": "go_merchant",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "boc_go_platinum"
        ],
        "settings": {},
        "usage": {
          "spend_boc_go_platinum_monthly": 1000
        }
      },
      "expected": {
        "topCardId": "boc_go_platinum",
        "topValue": 44,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_113_boc_go_platinum_mobile_bonus",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "apple_pay",
        "ownedCards": [
          "boc_go_platinum"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "boc_go_platinum",
        "topValue": 8,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_114_boc_go_platinum_mobile_cap_partial",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "apple_pay",
        "ownedCards": [
          "boc_go_platinum"
        ],
        "settings": {},
        "usage": {
          "boc_go_platinum_mobile_bonus_cap_2026": 24900
        }
      },
      "expected": {
        "topCardId": "boc_go_platinum",
        "topValue": 4.4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_115_boc_sogo_base_only",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "boc_sogo"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "boc_sogo",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_116_boc_sogo_mobile_bonus",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "apple_pay",
        "ownedCards": [
          "boc_sogo"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "boc_sogo",
        "topValue": 54,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_117_boc_sogo_designated_merchant",
      "input": {
        "amount": 1000,
        "category": "sogo_merchant",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "boc_sogo"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "boc_sogo",
        "topValue": 50,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_118_boc_sogo_designated_and_mobile_stack",
      "input": {
        "amount": 1000,
        "category": "sogo_merchant",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "apple_pay",
        "ownedCards": [
          "boc_sogo"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "boc_sogo",
        "topValue": 100,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_119_boc_sogo_mobile_cap_partial",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "apple_pay",
        "ownedCards": [
          "boc_sogo"
        ],
        "settings": {},
        "usage": {
          "boc_sogo_mobile_bonus_cap_2026": 90
        }
      },
      "expected": {
        "topCardId": "boc_sogo",
        "topValue": 14,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_120_boc_sogo_mobile_outside_window",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2027-01-05",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "apple_pay",
        "ownedCards": [
          "boc_sogo"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "boc_sogo",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_121_ae_explorer_base_only_no_registration",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "ae_explorer"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "ae_explorer",
        "topValue": 10,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_122_ae_explorer_overseas_2026h1_registered",
      "input": {
        "amount": 1000,
        "category": "overseas_other",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "ae_explorer"
        ],
        "settings": {
          "ae_explorer_075x_enabled": true,
          "ae_explorer_7x_enabled": true
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "ae_explorer",
        "topValue": 35.833333,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_123_ae_explorer_overseas_7x_cap_partial",
      "input": {
        "amount": 1000,
        "category": "overseas_other",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "ae_explorer"
        ],
        "settings": {
          "ae_explorer_075x_enabled": true,
          "ae_explorer_7x_enabled": true
        },
        "usage": {
          "ae_explorer_fx_7x_qcap_2026": 9500
        }
      },
      "expected": {
        "topCardId": "ae_explorer",
        "topValue": 24.166667,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_124_ae_explorer_travel_2026h1_registered",
      "input": {
        "amount": 1000,
        "category": "travel",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "ae_explorer"
        ],
        "settings": {
          "ae_explorer_075x_enabled": true,
          "ae_explorer_7x_enabled": true
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "ae_explorer",
        "topValue": 35.833333,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_125_ae_explorer_designated_online_5x",
      "input": {
        "amount": 1000,
        "category": "ae_online_designated",
        "date": "2026-09-10",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "ae_explorer"
        ],
        "settings": {
          "ae_explorer_online_5x_enabled": true
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "ae_explorer",
        "topValue": 16.666667,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_126_ae_explorer_designated_online_5x_cap_partial",
      "input": {
        "amount": 1000,
        "category": "ae_online_designated",
        "date": "2026-09-10",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "ae_explorer"
        ],
        "settings": {
          "ae_explorer_online_5x_enabled": true
        },
        "usage": {
          "ae_explorer_online_5x_bonus_qcap_2026": 89900
        }
      },
      "expected": {
        "topCardId": "ae_explorer",
        "topValue": 10.333333,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_127_ae_explorer_designated_online_travel_stack",
      "input": {
        "amount": 1000,
        "category": "ae_online_travel_designated",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "ae_explorer"
        ],
        "settings": {
          "ae_explorer_075x_enabled": true,
          "ae_explorer_7x_enabled": true,
          "ae_explorer_online_5x_enabled": true
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "ae_explorer",
        "topValue": 42.5,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_128_ae_explorer_wallet_not_eligible_for_extra",
      "input": {
        "amount": 1000,
        "category": "ae_online_designated",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "apple_pay",
        "ownedCards": [
          "ae_explorer"
        ],
        "settings": {
          "ae_explorer_075x_enabled": true,
          "ae_explorer_7x_enabled": true,
          "ae_explorer_online_5x_enabled": true
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "ae_explorer",
        "topValue": 10,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_129_ae_platinum_local_base_with_accelerator",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "ae_platinum"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "ae_platinum",
        "topValue": 6.666667,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_130_ae_platinum_accelerator_capped",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "ae_platinum"
        ],
        "settings": {},
        "usage": {
          "ae_plat_accelerator_cap": 160000
        }
      },
      "expected": {
        "topCardId": "ae_platinum",
        "topValue": 3.333333,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": true,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_131_ae_platinum_overseas_base",
      "input": {
        "amount": 1000,
        "category": "overseas_other",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "ae_platinum"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "ae_platinum",
        "topValue": 13.333333,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_132_ae_platinum_overseas_9x_registered",
      "input": {
        "amount": 1000,
        "category": "overseas_other",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "ae_platinum"
        ],
        "settings": {
          "ae_platinum_9x_enabled": true
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "ae_platinum",
        "topValue": 30,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_133_ae_platinum_overseas_9x_cap_partial",
      "input": {
        "amount": 1000,
        "category": "overseas_other",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "ae_platinum"
        ],
        "settings": {
          "ae_platinum_9x_enabled": true
        },
        "usage": {
          "ae_plat_fx_9x_cap": 14900
        }
      },
      "expected": {
        "topCardId": "ae_platinum",
        "topValue": 15,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_134_ae_platinum_travel_designated_9x",
      "input": {
        "amount": 1000,
        "category": "ae_plat_travel_designated",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "ae_platinum"
        ],
        "settings": {
          "ae_platinum_9x_enabled": true
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "ae_platinum",
        "topValue": 30,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_135_ae_platinum_daily_designated_9x",
      "input": {
        "amount": 1000,
        "category": "ae_plat_daily_designated",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "ae_platinum"
        ],
        "settings": {
          "ae_platinum_9x_enabled": true
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "ae_platinum",
        "topValue": 30,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_136_ae_platinum_promo_outside_window",
      "input": {
        "amount": 1000,
        "category": "ae_plat_travel_designated",
        "date": "2026-07-05",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "ae_platinum"
        ],
        "settings": {
          "ae_platinum_9x_enabled": true
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "ae_platinum",
        "topValue": 6.666667,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_137_ae_platinum_overseas_omycard_not_eligible_9x",
      "input": {
        "amount": 1000,
        "category": "overseas_other",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "omycard",
        "ownedCards": [
          "ae_platinum"
        ],
        "settings": {
          "ae_platinum_9x_enabled": true
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "ae_platinum",
        "topValue": 13.333333,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_138_ae_pcc_general_pre_program_cap",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "ae_platinum_credit"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "ae_platinum_credit",
        "topValue": 10,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_139_ae_pcc_general_post_program_cap",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "ae_platinum_credit"
        ],
        "settings": {},
        "usage": {
          "ae_pcc_program_3x_cap": 120000
        }
      },
      "expected": {
        "topCardId": "ae_platinum_credit",
        "topValue": 3.333333,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": true,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_140_ae_pcc_designated_pre_program_cap_double",
      "input": {
        "amount": 1000,
        "category": "ae_pcc_designated",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "ae_platinum_credit"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "ae_platinum_credit",
        "topValue": 20,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_141_ae_pcc_designated_post_program_cap_double",
      "input": {
        "amount": 1000,
        "category": "ae_pcc_designated",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "ae_platinum_credit"
        ],
        "settings": {},
        "usage": {
          "ae_pcc_program_3x_cap": 120000
        }
      },
      "expected": {
        "topCardId": "ae_platinum_credit",
        "topValue": 6.666667,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": true,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_142_ae_pcc_designated_monthly_cap_partial",
      "input": {
        "amount": 1000,
        "category": "ae_pcc_designated",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "ae_platinum_credit"
        ],
        "settings": {},
        "usage": {
          "ae_pcc_double_cap": 29500
        }
      },
      "expected": {
        "topCardId": "ae_platinum_credit",
        "topValue": 11.666667,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_143_ae_pcc_program_promo_outside_window",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2027-01-05",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "ae_platinum_credit"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "ae_platinum_credit",
        "topValue": 3.333333,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_144_fubon_in_online_locked_below_threshold",
      "input": {
        "amount": 500,
        "category": "general",
        "date": "2026-02-15",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "fubon_in_platinum"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "fubon_in_platinum",
        "topValue": 2.5,
        "breakdownFlags": {
          "hasLocked": true,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_145_fubon_in_online_unlock_same_tx",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-02-15",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "fubon_in_platinum"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "fubon_in_platinum",
        "topValue": 100,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_146_fubon_in_tuition_not_count_for_mission",
      "input": {
        "amount": 200,
        "category": "tuition",
        "date": "2026-02-15",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "fubon_in_platinum"
        ],
        "settings": {},
        "usage": {
          "fubon_in_monthly_eligible_spend": 900
        }
      },
      "expected": {
        "topCardId": "fubon_in_platinum",
        "topValue": 1,
        "breakdownFlags": {
          "hasLocked": true,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_147_fubon_in_online_bonus_partial_cap",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-02-15",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "fubon_in_platinum"
        ],
        "settings": {},
        "usage": {
          "fubon_in_monthly_eligible_spend": 1000,
          "fubon_in_bonus_cap": 62000
        }
      },
      "expected": {
        "topCardId": "fubon_in_platinum",
        "topValue": 7.5,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_148_fubon_travel_weekday_local_base",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-02-11",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "fubon_travel"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "fubon_travel",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_149_fubon_travel_weekend_local_2x",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-02-14",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "fubon_travel"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "fubon_travel",
        "topValue": 8,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_150_fubon_travel_tw_20x",
      "input": {
        "amount": 1000,
        "category": "overseas_tw",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "fubon_travel"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "fubon_travel",
        "topValue": 80,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_151_fubon_travel_jpkr_10x",
      "input": {
        "amount": 1000,
        "category": "overseas_jkt",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "fubon_travel"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "fubon_travel",
        "topValue": 40,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_152_fubon_travel_fx_other_5x",
      "input": {
        "amount": 1000,
        "category": "overseas_other",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "fubon_travel"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "fubon_travel",
        "topValue": 20,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_153_fubon_travel_overseas_bonus_partial_monthly_cap",
      "input": {
        "amount": 1000,
        "category": "overseas_tw",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "fubon_travel"
        ],
        "settings": {},
        "usage": {
          "fubon_travel_bonus_monthly_cap": 79000,
          "fubon_travel_bonus_annual_cap": 100000
        }
      },
      "expected": {
        "topCardId": "fubon_travel",
        "topValue": 8,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_154_fubon_travel_overseas_bonus_capped_yearly",
      "input": {
        "amount": 1000,
        "category": "overseas_tw",
        "date": "2026-11-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "fubon_travel"
        ],
        "settings": {},
        "usage": {
          "fubon_travel_bonus_monthly_cap": 0,
          "fubon_travel_bonus_annual_cap": 240000
        }
      },
      "expected": {
        "topCardId": "fubon_travel",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": true,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_155_fubon_upgrade_online_unregistered",
      "input": {
        "amount": 1000,
        "category": "fubon_upgrade_online",
        "date": "2026-02-10",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "fubon_travel"
        ],
        "settings": {
          "fubon_travel_upgrade_enabled": false
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "fubon_travel",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_156_fubon_upgrade_online_registered",
      "input": {
        "amount": 1000,
        "category": "fubon_upgrade_online",
        "date": "2026-02-10",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "fubon_travel"
        ],
        "settings": {
          "fubon_travel_upgrade_enabled": true
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "fubon_travel",
        "topValue": 40,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_157_fubon_upgrade_online_cap_partial",
      "input": {
        "amount": 1000,
        "category": "fubon_upgrade_online",
        "date": "2026-02-10",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "fubon_travel"
        ],
        "settings": {
          "fubon_travel_upgrade_enabled": true
        },
        "usage": {
          "fubon_travel_upgrade_online_cap": 62000
        }
      },
      "expected": {
        "topCardId": "fubon_travel",
        "topValue": 2,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_158_fubon_travel_jpkr_new_category",
      "input": {
        "amount": 1000,
        "category": "overseas_jpkr",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "fubon_travel"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "fubon_travel",
        "topValue": 40,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_159_fubon_travel_th_new_category",
      "input": {
        "amount": 1000,
        "category": "overseas_th",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "fubon_travel"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "fubon_travel",
        "topValue": 20,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_160_travel_plus_jpkr_tier1_mission_met",
      "input": {
        "amount": 2500,
        "category": "overseas_jpkr",
        "date": "2026-05-01",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "hangseng_travel_plus"
        ],
        "settings": {
          "travel_plus_promo_enabled": true
        },
        "usage": {
          "spend_hangseng_travel_plus": 8000
        }
      },
      "expected": {
        "topCardId": "hangseng_travel_plus",
        "topValue": 175,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_161_fubon_infinite_local_weekday_base",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-02-11",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "fubon_infinite"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "fubon_infinite",
        "topValue": 5,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_162_fubon_infinite_local_weekend_2x",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-02-14",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "fubon_infinite"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "fubon_infinite",
        "topValue": 10,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_163_fubon_infinite_local_weekend_below_300",
      "input": {
        "amount": 200,
        "category": "general",
        "date": "2026-02-14",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "fubon_infinite"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "fubon_infinite",
        "topValue": 1,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_164_fubon_infinite_tw_20x",
      "input": {
        "amount": 1000,
        "category": "overseas_tw",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "fubon_infinite"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "fubon_infinite",
        "topValue": 100,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_165_fubon_infinite_jpkr_10x",
      "input": {
        "amount": 1000,
        "category": "overseas_jpkr",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "fubon_infinite"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "fubon_infinite",
        "topValue": 50,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_166_fubon_infinite_th_5x",
      "input": {
        "amount": 1000,
        "category": "overseas_th",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "fubon_infinite"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "fubon_infinite",
        "topValue": 25,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_167_fubon_infinite_upgrade_unregistered",
      "input": {
        "amount": 1000,
        "category": "fubon_upgrade_online",
        "date": "2026-02-11",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "fubon_infinite"
        ],
        "settings": {
          "fubon_infinite_upgrade_enabled": false
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "fubon_infinite",
        "topValue": 5,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_168_fubon_infinite_upgrade_registered_locked",
      "input": {
        "amount": 500,
        "category": "fubon_upgrade_online",
        "date": "2026-02-11",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "fubon_infinite"
        ],
        "settings": {
          "fubon_infinite_upgrade_enabled": true
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "fubon_infinite",
        "topValue": 2.5,
        "breakdownFlags": {
          "hasLocked": true,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_169_fubon_infinite_upgrade_unlock_same_tx",
      "input": {
        "amount": 1000,
        "category": "fubon_upgrade_online",
        "date": "2026-02-11",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "fubon_infinite"
        ],
        "settings": {
          "fubon_infinite_upgrade_enabled": true
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "fubon_infinite",
        "topValue": 45,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_170_fubon_infinite_upgrade_weekend_10x",
      "input": {
        "amount": 1000,
        "category": "fubon_upgrade_online",
        "date": "2026-02-14",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "fubon_infinite"
        ],
        "settings": {
          "fubon_infinite_upgrade_enabled": true
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "fubon_infinite",
        "topValue": 50,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_171_fubon_infinite_upgrade_partial_cap",
      "input": {
        "amount": 1000,
        "category": "fubon_upgrade_online",
        "date": "2026-02-11",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "fubon_infinite"
        ],
        "settings": {
          "fubon_infinite_upgrade_enabled": true
        },
        "usage": {
          "fubon_infinite_upgrade_monthly_spend": 1000,
          "fubon_infinite_upgrade_online_cap": 79000
        }
      },
      "expected": {
        "topCardId": "fubon_infinite",
        "topValue": 10,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_171b_fubon_upgrade_online_by_flag_general_online",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-02-10",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "fubon_travel"
        ],
        "settings": {
          "fubon_travel_upgrade_enabled": true
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "fubon_travel",
        "topValue": 40,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_172_fubon_infinite_overseas_partial_monthly_cap",
      "input": {
        "amount": 1000,
        "category": "overseas_tw",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "fubon_infinite"
        ],
        "settings": {},
        "usage": {
          "fubon_infinite_bonus_monthly_cap": 79000,
          "fubon_infinite_bonus_annual_cap": 100000
        }
      },
      "expected": {
        "topCardId": "fubon_infinite",
        "topValue": 5,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_173_fubon_infinite_overseas_capped_yearly",
      "input": {
        "amount": 1000,
        "category": "overseas_tw",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "fubon_infinite"
        ],
        "settings": {},
        "usage": {
          "fubon_infinite_bonus_monthly_cap": 0,
          "fubon_infinite_bonus_annual_cap": 240000
        }
      },
      "expected": {
        "topCardId": "fubon_infinite",
        "topValue": 5,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": true,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_174_bea_goal_general_base_only",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "bea_goal"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "bea_goal",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_175_bea_goal_travel_locked",
      "input": {
        "amount": 1000,
        "category": "travel",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "bea_goal"
        ],
        "settings": {},
        "usage": {
          "bea_goal_mission": 0
        }
      },
      "expected": {
        "topCardId": "bea_goal",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": true,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_176_bea_goal_travel_unlocked",
      "input": {
        "amount": 1000,
        "category": "travel",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "bea_goal"
        ],
        "settings": {},
        "usage": {
          "bea_goal_mission": 2000
        }
      },
      "expected": {
        "topCardId": "bea_goal",
        "topValue": 64,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_177_bea_goal_entertainment_unlocked",
      "input": {
        "amount": 1000,
        "category": "entertainment",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "bea_goal"
        ],
        "settings": {},
        "usage": {
          "bea_goal_mission": 2000
        }
      },
      "expected": {
        "topCardId": "bea_goal",
        "topValue": 54,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_178_bea_goal_online_unlocked",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "bea_goal"
        ],
        "settings": {},
        "usage": {
          "bea_goal_mission": 2000
        }
      },
      "expected": {
        "topCardId": "bea_goal",
        "topValue": 44,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_179_bea_goal_mobile_unlocked",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "apple_pay",
        "ownedCards": [
          "bea_goal"
        ],
        "settings": {},
        "usage": {
          "bea_goal_mission": 2000
        }
      },
      "expected": {
        "topCardId": "bea_goal",
        "topValue": 44,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_180_bea_goal_travel_online_prefers_6pct",
      "input": {
        "amount": 1000,
        "category": "travel",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "bea_goal"
        ],
        "settings": {},
        "usage": {
          "bea_goal_mission": 2000
        }
      },
      "expected": {
        "topCardId": "bea_goal",
        "topValue": 64,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_181_bea_goal_bonus_partial_cap",
      "input": {
        "amount": 1000,
        "category": "travel",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "bea_goal"
        ],
        "settings": {},
        "usage": {
          "bea_goal_mission": 2000,
          "bea_goal_cap": 180
        }
      },
      "expected": {
        "topCardId": "bea_goal",
        "topValue": 24,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_182_bea_goal_bonus_capped",
      "input": {
        "amount": 1000,
        "category": "travel",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "bea_goal"
        ],
        "settings": {},
        "usage": {
          "bea_goal_mission": 2000,
          "bea_goal_cap": 200
        }
      },
      "expected": {
        "topCardId": "bea_goal",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": true,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_183_bea_goal_outside_window",
      "input": {
        "amount": 1000,
        "category": "travel",
        "date": "2026-07-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "bea_goal"
        ],
        "settings": {},
        "usage": {
          "bea_goal_mission": 2000
        }
      },
      "expected": {
        "topCardId": "bea_goal",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_184_bea_world_spending_locked",
      "input": {
        "amount": 1000,
        "category": "overseas_tw",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "bea_world"
        ],
        "settings": {},
        "usage": {
          "bea_world_mission": 0
        }
      },
      "expected": {
        "topCardId": "bea_world",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": true,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_185_bea_world_spending_unlocked",
      "input": {
        "amount": 1000,
        "category": "overseas_tw",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "bea_world"
        ],
        "settings": {},
        "usage": {
          "bea_world_mission": 4000
        }
      },
      "expected": {
        "topCardId": "bea_world",
        "topValue": 50,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_186_bea_world_flying_overseas",
      "input": {
        "amount": 1000,
        "category": "overseas_tw",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "bea_world"
        ],
        "settings": {
          "bea_world_flying_miles_enabled": true
        },
        "usage": {
          "bea_world_mission": 4000
        }
      },
      "expected": {
        "topCardId": "bea_world",
        "topValue": 8,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_187_bea_world_flying_local_designated",
      "input": {
        "amount": 1000,
        "category": "electronics",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "bea_world"
        ],
        "settings": {
          "bea_world_flying_miles_enabled": true
        },
        "usage": {
          "bea_world_mission": 4000
        }
      },
      "expected": {
        "topCardId": "bea_world",
        "topValue": 6.4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_188_bea_world_flying_local_non_designated",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "bea_world"
        ],
        "settings": {
          "bea_world_flying_miles_enabled": true
        },
        "usage": {
          "bea_world_mission": 4000
        }
      },
      "expected": {
        "topCardId": "bea_world",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_189_bea_world_flying_outside_window",
      "input": {
        "amount": 1000,
        "category": "overseas_tw",
        "date": "2026-07-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "bea_world"
        ],
        "settings": {
          "bea_world_flying_miles_enabled": true
        },
        "usage": {
          "bea_world_mission": 4000
        }
      },
      "expected": {
        "topCardId": "bea_world",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_190_bea_ititanium_default_base",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "bea_ititanium"
        ],
        "settings": {},
        "usage": {
          "bea_ititanium_mission": 2000
        }
      },
      "expected": {
        "topCardId": "bea_ititanium",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_191_bea_ititanium_enabled_unlocked",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "bea_ititanium"
        ],
        "settings": {
          "bea_ititanium_bonus_enabled": true
        },
        "usage": {
          "bea_ititanium_mission": 2000
        }
      },
      "expected": {
        "topCardId": "bea_ititanium",
        "topValue": 36,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_192_bea_ititanium_enabled_capped",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "bea_ititanium"
        ],
        "settings": {
          "bea_ititanium_bonus_enabled": true
        },
        "usage": {
          "bea_ititanium_mission": 2000,
          "bea_ititanium_cap": 300
        }
      },
      "expected": {
        "topCardId": "bea_ititanium",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": true,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_193_bea_unionpay_rmb_13x",
      "input": {
        "amount": 1000,
        "category": "overseas_cn",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "bea_unionpay_diamond"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "bea_unionpay_diamond",
        "topValue": 52,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_194_bea_unionpay_fx_11x",
      "input": {
        "amount": 1000,
        "category": "overseas_tw",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "bea_unionpay_diamond"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "bea_unionpay_diamond",
        "topValue": 44,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_195_bea_unionpay_dining_4x",
      "input": {
        "amount": 1000,
        "category": "dining",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "bea_unionpay_diamond"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "bea_unionpay_diamond",
        "topValue": 16,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_196_bea_unionpay_local_3x",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "bea_unionpay_diamond"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "bea_unionpay_diamond",
        "topValue": 12,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_197_bea_unionpay_outside_window_base",
      "input": {
        "amount": 1000,
        "category": "overseas_cn",
        "date": "2026-07-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "bea_unionpay_diamond"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "bea_unionpay_diamond",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_198_sim_online_locked",
      "input": {
        "amount": 600,
        "category": "general",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "sim_credit"
        ],
        "settings": {
          "sim_promo_enabled": true
        },
        "usage": {
          "sim_non_online_spend": 0
        }
      },
      "expected": {
        "topCardId": "sim_credit",
        "topValue": 2.4,
        "breakdownFlags": {
          "hasLocked": true,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_199_sim_online_unlocked",
      "input": {
        "amount": 600,
        "category": "general",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "sim_credit"
        ],
        "settings": {
          "sim_promo_enabled": true
        },
        "usage": {
          "sim_non_online_spend": 1000
        }
      },
      "expected": {
        "topCardId": "sim_credit",
        "topValue": 48,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_200_sim_online_below_min_single",
      "input": {
        "amount": 400,
        "category": "general",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "sim_credit"
        ],
        "settings": {
          "sim_promo_enabled": true
        },
        "usage": {
          "sim_non_online_spend": 1000
        }
      },
      "expected": {
        "topCardId": "sim_credit",
        "topValue": 1.6,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_201_sim_transport_offline_unlocked",
      "input": {
        "amount": 100,
        "category": "transport",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "sim_credit"
        ],
        "settings": {
          "sim_promo_enabled": true
        },
        "usage": {
          "sim_non_online_spend": 1000
        }
      },
      "expected": {
        "topCardId": "sim_credit",
        "topValue": 8,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_202_sim_transport_online_follows_online_rule",
      "input": {
        "amount": 300,
        "category": "transport",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "sim_credit"
        ],
        "settings": {
          "sim_promo_enabled": true
        },
        "usage": {
          "sim_non_online_spend": 1000
        }
      },
      "expected": {
        "topCardId": "sim_credit",
        "topValue": 1.2,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_203_sim_designated_merchant_unlocked",
      "input": {
        "amount": 1000,
        "category": "sim_designated_merchant",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "sim_credit"
        ],
        "settings": {
          "sim_promo_enabled": true
        },
        "usage": {
          "sim_non_online_spend": 1000
        }
      },
      "expected": {
        "topCardId": "sim_credit",
        "topValue": 30,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_204_sim_billpay_unlocked",
      "input": {
        "amount": 1000,
        "category": "sim_billpay",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "sim_credit"
        ],
        "settings": {
          "sim_promo_enabled": true
        },
        "usage": {
          "sim_non_online_spend": 1000
        }
      },
      "expected": {
        "topCardId": "sim_credit",
        "topValue": 20,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_205_sim_monthly_cap_partial",
      "input": {
        "amount": 1000,
        "category": "transport",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "sim_credit"
        ],
        "settings": {
          "sim_promo_enabled": true
        },
        "usage": {
          "sim_non_online_spend": 1000,
          "sim_promo_cap_monthly": 190,
          "sim_promo_cap_total": 190
        }
      },
      "expected": {
        "topCardId": "sim_credit",
        "topValue": 14,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_206_sim_monthly_cap_capped",
      "input": {
        "amount": 1000,
        "category": "transport",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "sim_credit"
        ],
        "settings": {
          "sim_promo_enabled": true
        },
        "usage": {
          "sim_non_online_spend": 1000,
          "sim_promo_cap_monthly": 200,
          "sim_promo_cap_total": 200
        }
      },
      "expected": {
        "topCardId": "sim_credit",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": true,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_207_sim_total_cap_capped",
      "input": {
        "amount": 1000,
        "category": "transport",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "sim_credit"
        ],
        "settings": {
          "sim_promo_enabled": true
        },
        "usage": {
          "sim_non_online_spend": 1000,
          "sim_promo_cap_monthly": 0,
          "sim_promo_cap_total": 600
        }
      },
      "expected": {
        "topCardId": "sim_credit",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": true,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_208_sim_outside_window",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-05-10",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "sim_credit"
        ],
        "settings": {
          "sim_promo_enabled": true
        },
        "usage": {
          "sim_non_online_spend": 1000
        }
      },
      "expected": {
        "topCardId": "sim_credit",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_209_sim_world_overseas_locked",
      "input": {
        "amount": 500,
        "category": "overseas_tw",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "sim_world"
        ],
        "settings": {
          "sim_world_promo_enabled": true
        },
        "usage": {
          "sim_world_non_online_spend": 0
        }
      },
      "expected": {
        "topCardId": "sim_world",
        "topValue": 2,
        "breakdownFlags": {
          "hasLocked": true,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_210_sim_world_overseas_unlocked",
      "input": {
        "amount": 1000,
        "category": "overseas_tw",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "sim_world"
        ],
        "settings": {
          "sim_world_promo_enabled": true
        },
        "usage": {
          "sim_world_non_online_spend": 1000
        }
      },
      "expected": {
        "topCardId": "sim_world",
        "topValue": 80,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_211_sim_world_online_unlocked",
      "input": {
        "amount": 600,
        "category": "general",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "sim_world"
        ],
        "settings": {
          "sim_world_promo_enabled": true
        },
        "usage": {
          "sim_world_non_online_spend": 1000
        }
      },
      "expected": {
        "topCardId": "sim_world",
        "topValue": 48,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_212_sim_world_overseas_online_not_double_count",
      "input": {
        "amount": 300,
        "category": "overseas_tw",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "sim_world"
        ],
        "settings": {
          "sim_world_promo_enabled": true
        },
        "usage": {
          "sim_world_non_online_spend": 1000
        }
      },
      "expected": {
        "topCardId": "sim_world",
        "topValue": 1.2,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_213_sim_world_designated_merchant_unlocked",
      "input": {
        "amount": 1000,
        "category": "sim_designated_merchant",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "sim_world"
        ],
        "settings": {
          "sim_world_promo_enabled": true
        },
        "usage": {
          "sim_world_non_online_spend": 1000
        }
      },
      "expected": {
        "topCardId": "sim_world",
        "topValue": 30,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_214_sim_world_billpay_unlocked",
      "input": {
        "amount": 1000,
        "category": "sim_billpay",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "sim_world"
        ],
        "settings": {
          "sim_world_promo_enabled": true
        },
        "usage": {
          "sim_world_non_online_spend": 1000
        }
      },
      "expected": {
        "topCardId": "sim_world",
        "topValue": 20,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_215_sim_world_monthly_cap_partial",
      "input": {
        "amount": 1000,
        "category": "overseas_tw",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "sim_world"
        ],
        "settings": {
          "sim_world_promo_enabled": true
        },
        "usage": {
          "sim_world_non_online_spend": 1000,
          "sim_world_promo_cap_monthly": 190,
          "sim_world_promo_cap_total": 190
        }
      },
      "expected": {
        "topCardId": "sim_world",
        "topValue": 14,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_216_sim_world_total_cap_capped",
      "input": {
        "amount": 1000,
        "category": "overseas_tw",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "sim_world"
        ],
        "settings": {
          "sim_world_promo_enabled": true
        },
        "usage": {
          "sim_world_non_online_spend": 1000,
          "sim_world_promo_cap_monthly": 0,
          "sim_world_promo_cap_total": 600
        }
      },
      "expected": {
        "topCardId": "sim_world",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": true,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_217_sim_world_outside_window",
      "input": {
        "amount": 1000,
        "category": "overseas_tw",
        "date": "2026-05-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "sim_world"
        ],
        "settings": {
          "sim_world_promo_enabled": true
        },
        "usage": {
          "sim_world_non_online_spend": 1000
        }
      },
      "expected": {
        "topCardId": "sim_world",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_218_aeon_waku_base_general",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-01-15",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "aeon_wakuwaku"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "aeon_wakuwaku",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_219_aeon_waku_dining_offline",
      "input": {
        "amount": 1000,
        "category": "dining",
        "date": "2026-01-15",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "aeon_wakuwaku"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "aeon_wakuwaku",
        "topValue": 10,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_220_aeon_waku_japan_offline",
      "input": {
        "amount": 1000,
        "category": "overseas_jp",
        "date": "2026-01-15",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "aeon_wakuwaku"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "aeon_wakuwaku",
        "topValue": 30,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_221_aeon_waku_online_eligible",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-01-15",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "aeon_wakuwaku"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "aeon_wakuwaku",
        "topValue": 60,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_222_aeon_waku_online_below_500",
      "input": {
        "amount": 400,
        "category": "general",
        "date": "2026-01-15",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "aeon_wakuwaku"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "aeon_wakuwaku",
        "topValue": 1.6,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_223_aeon_waku_online_partial_cap",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-01-15",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "aeon_wakuwaku"
        ],
        "settings": {},
        "usage": {
          "aeon_waku_bonus_cap": 190
        }
      },
      "expected": {
        "topCardId": "aeon_wakuwaku",
        "topValue": 14,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_224_aeon_waku_online_capped",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-01-15",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "aeon_wakuwaku"
        ],
        "settings": {},
        "usage": {
          "aeon_waku_bonus_cap": 200
        }
      },
      "expected": {
        "topCardId": "aeon_wakuwaku",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": true,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_225_aeon_waku_outside_window",
      "input": {
        "amount": 1000,
        "category": "overseas_jp",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "aeon_wakuwaku"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "aeon_wakuwaku",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_226_wewa_mobile_unlock",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-02-12",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "apple_pay",
        "ownedCards": [
          "wewa"
        ],
        "settings": {
          "wewa_selected_category": "mobile_pay"
        },
        "usage": {
          "wewa_monthly_eligible_spend": 500
        }
      },
      "expected": {
        "topCardId": "wewa",
        "topValue": 40,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_227_wewa_mobile_locked",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-02-12",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "apple_pay",
        "ownedCards": [
          "wewa"
        ],
        "settings": {
          "wewa_selected_category": "mobile_pay"
        },
        "usage": {
          "wewa_monthly_eligible_spend": 0
        }
      },
      "expected": {
        "topCardId": "wewa",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": true,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_228_wewa_mobile_partial_cap",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-02-12",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "apple_pay",
        "ownedCards": [
          "wewa"
        ],
        "settings": {
          "wewa_selected_category": "mobile_pay"
        },
        "usage": {
          "wewa_monthly_eligible_spend": 2000,
          "wewa_selected_bonus_cap": 190
        }
      },
      "expected": {
        "topCardId": "wewa",
        "topValue": 14,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_229_wewa_overseas_not_registered",
      "input": {
        "amount": 1000,
        "category": "overseas_jp",
        "date": "2026-02-12",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "wewa"
        ],
        "settings": {
          "wewa_selected_category": "mobile_pay",
          "wewa_overseas_5pct_enabled": false
        },
        "usage": {
          "wewa_monthly_eligible_spend": 3000,
          "wewa_overseas_stage_spend": 1000
        }
      },
      "expected": {
        "topCardId": "wewa",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_230_wewa_overseas_registered_met",
      "input": {
        "amount": 200,
        "category": "overseas_jp",
        "date": "2026-02-12",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "wewa"
        ],
        "settings": {
          "wewa_selected_category": "mobile_pay",
          "wewa_overseas_5pct_enabled": true
        },
        "usage": {
          "wewa_monthly_eligible_spend": 3000,
          "wewa_overseas_stage_spend": 400
        }
      },
      "expected": {
        "topCardId": "wewa",
        "topValue": 10.8,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_231_earnmore_local_2pct",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-02-12",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "earnmore"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "earnmore",
        "topValue": 20,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_232_earnmore_overseas_online_2pct",
      "input": {
        "amount": 2500,
        "category": "overseas_jp",
        "date": "2026-02-12",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "earnmore"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "earnmore",
        "topValue": 50,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_233_earnmore_bonus_capped_base_only",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-02-12",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "earnmore"
        ],
        "settings": {},
        "usage": {
          "earnmore_bonus_cap_2026q1": 800
        }
      },
      "expected": {
        "topCardId": "earnmore",
        "topValue": 10,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": true,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_234_earnmore_outside_promo_base_1pct",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-07-15",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "earnmore"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "earnmore",
        "topValue": 10,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_235_mox_general_default_1pct",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-02-12",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "mox_credit"
        ],
        "settings": {
          "mox_deposit_task_enabled": false
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "mox_credit",
        "topValue": 10,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_236_mox_general_condition_met_2pct",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-02-12",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "mox_credit"
        ],
        "settings": {
          "mox_deposit_task_enabled": true
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "mox_credit",
        "topValue": 20,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_237_mox_dining_2pct_when_unlocked",
      "input": {
        "amount": 1000,
        "category": "dining",
        "date": "2026-02-12",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "mox_credit"
        ],
        "settings": {
          "mox_deposit_task_enabled": true
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "mox_credit",
        "topValue": 20,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_238_mox_grocery_3pct_without_condition",
      "input": {
        "amount": 1000,
        "category": "grocery",
        "date": "2026-02-12",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "mox_credit"
        ],
        "settings": {
          "mox_deposit_task_enabled": false
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "mox_credit",
        "topValue": 30,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_239_mox_before_202512_only_1pct",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2025-11-15",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "mox_credit"
        ],
        "settings": {
          "mox_deposit_task_enabled": true
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "mox_credit",
        "topValue": 10,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_240_mox_miles_unlocked_hkd4_per_mile",
      "input": {
        "amount": 400,
        "category": "general",
        "date": "2026-02-12",
        "displayMode": "miles",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "mox_credit"
        ],
        "settings": {
          "mox_reward_mode": "miles",
          "mox_deposit_task_enabled": true
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "mox_credit",
        "topValue": 100,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_241_mox_miles_promo_hkd8_per_mile",
      "input": {
        "amount": 800,
        "category": "general",
        "date": "2026-02-12",
        "displayMode": "miles",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "mox_credit"
        ],
        "settings": {
          "mox_reward_mode": "miles",
          "mox_deposit_task_enabled": false
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "mox_credit",
        "topValue": 100,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_242_mox_miles_regular_hkd10_per_mile",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-04-12",
        "displayMode": "miles",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "mox_credit"
        ],
        "settings": {
          "mox_reward_mode": "miles",
          "mox_deposit_task_enabled": false
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "mox_credit",
        "topValue": 100,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_243_mox_miles_mode_not_using_dining_3pct",
      "input": {
        "amount": 1000,
        "category": "dining",
        "date": "2026-02-12",
        "displayMode": "miles",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "mox_credit"
        ],
        "settings": {
          "mox_reward_mode": "miles",
          "mox_deposit_task_enabled": true
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "mox_credit",
        "topValue": 250,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_244_mox_miles_mode_before_start_zero",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2025-11-15",
        "displayMode": "miles",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "mox_credit"
        ],
        "settings": {
          "mox_reward_mode": "miles",
          "mox_deposit_task_enabled": false
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "mox_credit",
        "topValue": 0,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_245_travel_guru_go_level_not_locked_by_unlock_spend",
      "input": {
        "amount": 1000,
        "category": "overseas_other",
        "date": "2026-02-12",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "hsbc_everymile"
        ],
        "settings": {
          "travel_guru_registered": true,
          "guru_level": 1,
          "em_promo_enabled": false
        },
        "usage": {
          "spend_guru_unlock": 0,
          "guru_rc_used": 0
        }
      },
      "expected": {
        "topCardId": "hsbc_everymile",
        "topValue": 40,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_246_amount_zero_returns_null",
      "input": {
        "amount": 0,
        "category": "general",
        "date": "2026-02-12",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "hsbc_red",
          "hsbc_everymile"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": null,
        "topValue": 0,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_247_red_online_reward_cap_partial",
      "input": {
        "amount": 10000,
        "category": "general",
        "date": "2026-02-12",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "hsbc_red"
        ],
        "settings": {},
        "usage": {
          "red_online_bonus_cap": 350
        }
      },
      "expected": {
        "topCardId": "hsbc_red",
        "topValue": 50,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_248_red_online_fully_capped",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-02-12",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "hsbc_red"
        ],
        "settings": {},
        "usage": {
          "red_online_bonus_cap": 360
        }
      },
      "expected": {
        "topCardId": "hsbc_red",
        "topValue": 4,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": true,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_248a_red_designated_offline_under_cap",
      "input": {
        "amount": 1000,
        "category": "red_designated",
        "date": "2026-02-12",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "hsbc_red"
        ],
        "settings": {},
        "usage": {}
      },
      "expected": {
        "topCardId": "hsbc_red",
        "topValue": 80,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_248b_red_designated_offline_partial_cap",
      "input": {
        "amount": 1000,
        "category": "red_designated",
        "date": "2026-02-12",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "hsbc_red"
        ],
        "settings": {},
        "usage": {
          "red_designated_spend_cap": 1000
        }
      },
      "expected": {
        "topCardId": "hsbc_red",
        "topValue": 23,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_248c_red_designated_online_partial_cap_overflow",
      "input": {
        "amount": 2000,
        "category": "red_designated",
        "date": "2026-02-12",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "hsbc_red"
        ],
        "settings": {},
        "usage": {
          "red_designated_spend_cap": 1000,
          "red_online_bonus_cap": 0
        }
      },
      "expected": {
        "topCardId": "hsbc_red",
        "topValue": 90,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_248d_red_designated_online_overflow_bonus_capped",
      "input": {
        "amount": 2000,
        "category": "red_designated",
        "date": "2026-02-12",
        "displayMode": "cash",
        "isOnline": true,
        "paymentMethod": "physical",
        "ownedCards": [
          "hsbc_red"
        ],
        "settings": {},
        "usage": {
          "red_designated_spend_cap": 1250,
          "red_online_bonus_cap": 350
        }
      },
      "expected": {
        "topCardId": "hsbc_red",
        "topValue": 18,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": true,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_249_sc_smart_spending_cap_partial",
      "input": {
        "amount": 500,
        "category": "smart_designated",
        "date": "2026-02-12",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "sc_smart"
        ],
        "settings": {},
        "usage": {
          "sc_smart_cap": 4900,
          "sc_smart_monthly_eligible": 5000
        }
      },
      "expected": {
        "topCardId": "sc_smart",
        "topValue": 7.24,
        "breakdownFlags": {
          "hasLocked": true,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_250_em_promo_locked_retroactive",
      "input": {
        "amount": 1000,
        "category": "overseas_other",
        "date": "2026-02-12",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "hsbc_everymile"
        ],
        "settings": {
          "em_promo_enabled": true
        },
        "usage": {
          "em_q1_total": 5000
        }
      },
      "expected": {
        "topCardId": "hsbc_everymile",
        "topValue": 10,
        "breakdownFlags": {
          "hasLocked": true,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_251_em_promo_unlocked",
      "input": {
        "amount": 1000,
        "category": "overseas_other",
        "date": "2026-02-12",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": [
          "hsbc_everymile"
        ],
        "settings": {
          "em_promo_enabled": true
        },
        "usage": {
          "em_q1_total": 12000
        }
      },
      "expected": {
        "topCardId": "hsbc_everymile",
        "topValue": 25,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_252_red_mcd_stamp_progress_only",
      "input": {
        "amount": 50,
        "category": "fastfood",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "merchantId": "mcdonalds",
        "ownedCards": [
          "hsbc_red"
        ],
        "settings": {
          "red_mcd_stamp_enabled": true
        },
        "usage": {
          "red_mcd_stamp_total": 2,
          "red_mcd_stamp_month": 2
        }
      },
      "expected": {
        "topCardId": "hsbc_red",
        "topValue": 0.2,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_253_red_mcd_stamp_unlock_reward",
      "input": {
        "amount": 50,
        "category": "fastfood",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "merchantId": "mcdonalds",
        "ownedCards": [
          "hsbc_red"
        ],
        "settings": {
          "red_mcd_stamp_enabled": true
        },
        "usage": {
          "red_mcd_stamp_total": 3,
          "red_mcd_stamp_month": 3
        }
      },
      "expected": {
        "topCardId": "hsbc_red",
        "topValue": 15.2,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_254_red_mcd_stamp_daily_limit",
      "input": {
        "amount": 50,
        "category": "fastfood",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "merchantId": "mcdonalds",
        "ownedCards": [
          "hsbc_red"
        ],
        "settings": {
          "red_mcd_stamp_enabled": true
        },
        "usage": {
          "red_mcd_stamp_total": 3,
          "red_mcd_stamp_month": 3,
          "red_mcd_stamp_day_2026-03-10": 1
        }
      },
      "expected": {
        "topCardId": "hsbc_red",
        "topValue": 0.2,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_255_red_mcd_stamp_monthly_limit",
      "input": {
        "amount": 50,
        "category": "fastfood",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "merchantId": "mcdonalds",
        "ownedCards": [
          "hsbc_red"
        ],
        "settings": {
          "red_mcd_stamp_enabled": true
        },
        "usage": {
          "red_mcd_stamp_total": 40,
          "red_mcd_stamp_month": 8
        }
      },
      "expected": {
        "topCardId": "hsbc_red",
        "topValue": 0.2,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_256_red_mcd_stamp_reward_cap_partial",
      "input": {
        "amount": 50,
        "category": "fastfood",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "merchantId": "mcdonalds",
        "ownedCards": [
          "hsbc_red"
        ],
        "settings": {
          "red_mcd_stamp_enabled": true
        },
        "usage": {
          "red_mcd_stamp_total": 3,
          "red_mcd_stamp_month": 3,
          "red_mcd_reward_cap": 355
        }
      },
      "expected": {
        "topCardId": "hsbc_red",
        "topValue": 5.2,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": true
        }
      }
    },
    {
      "id": "case_257_red_mcd_stamp_non_target_merchant",
      "input": {
        "amount": 50,
        "category": "fastfood",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "merchantId": "kfc",
        "ownedCards": [
          "hsbc_red"
        ],
        "settings": {
          "red_mcd_stamp_enabled": true
        },
        "usage": {
          "red_mcd_stamp_total": 3,
          "red_mcd_stamp_month": 3
        }
      },
      "expected": {
        "topCardId": "hsbc_red",
        "topValue": 0.2,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_258_red_mcd_stamp_unregistered",
      "input": {
        "amount": 50,
        "category": "fastfood",
        "date": "2026-03-10",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "merchantId": "mcdonalds",
        "ownedCards": [
          "hsbc_red"
        ],
        "settings": {
          "red_mcd_stamp_enabled": false
        },
        "usage": {
          "red_mcd_stamp_total": 3,
          "red_mcd_stamp_month": 3
        }
      },
      "expected": {
        "topCardId": "hsbc_red",
        "topValue": 0.2,
        "breakdownFlags": {
          "hasLocked": false,
          "hasCapped": false,
          "hasPartial": false
        }
      }
    },
    {
      "id": "case_259_red_hot_entertainment_no_merchant",
      "input": {
        "amount": 1000,
        "category": "entertainment",
        "date": "2026-02-12",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": ["hsbc_vs"],
        "settings": {
          "red_hot_rewards_enabled": true,
          "red_hot_allocation": { "dining": 0, "world": 0, "home": 0, "enjoyment": 5, "style": 0 }
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "hsbc_vs",
        "topValue": 4,
        "breakdownFlags": { "hasLocked": false, "hasCapped": false, "hasPartial": false }
      }
    },
    {
      "id": "case_260_red_hot_entertainment_non_designated_merchant",
      "input": {
        "amount": 1000,
        "category": "entertainment",
        "date": "2026-02-12",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "merchantId": "netflix",
        "ownedCards": ["hsbc_vs"],
        "settings": {
          "red_hot_rewards_enabled": true,
          "red_hot_allocation": { "dining": 0, "world": 0, "home": 0, "enjoyment": 5, "style": 0 }
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "hsbc_vs",
        "topValue": 4,
        "breakdownFlags": { "hasLocked": false, "hasCapped": false, "hasPartial": false }
      }
    },
    {
      "id": "case_261_red_hot_gym_merchant_maps_to_entertainment",
      "input": {
        "amount": 1000,
        "category": "gym",
        "date": "2026-02-12",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "merchantId": "be_earth",
        "ownedCards": ["hsbc_vs"],
        "settings": {
          "red_hot_rewards_enabled": true,
          "red_hot_allocation": { "dining": 0, "world": 0, "home": 0, "enjoyment": 5, "style": 0 }
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "hsbc_vs",
        "topValue": 36,
        "breakdownFlags": { "hasLocked": false, "hasCapped": false, "hasPartial": false }
      }
    },
    {
      "id": "case_262_red_hot_transport_no_merchant_no_bonus",
      "input": {
        "amount": 1000,
        "category": "transport",
        "date": "2026-02-12",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": ["hsbc_vs"],
        "settings": {
          "red_hot_rewards_enabled": true,
          "red_hot_allocation": { "dining": 0, "world": 0, "home": 0, "enjoyment": 5, "style": 0 }
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "hsbc_vs",
        "topValue": 4,
        "breakdownFlags": { "hasLocked": false, "hasCapped": false, "hasPartial": false }
      }
    },
    {
      "id": "case_263_red_hot_dining_no_merchant_unrestricted",
      "input": {
        "amount": 1000,
        "category": "dining",
        "date": "2026-02-12",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": ["hsbc_vs"],
        "settings": {
          "red_hot_rewards_enabled": true,
          "red_hot_allocation": { "dining": 5, "world": 0, "home": 0, "enjoyment": 0, "style": 0 }
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "hsbc_vs",
        "topValue": 36,
        "breakdownFlags": { "hasLocked": false, "hasCapped": false, "hasPartial": false }
      }
    },
    {
      "id": "case_264_red_hot_overseas_no_merchant_unrestricted",
      "input": {
        "amount": 1000,
        "category": "overseas_jp",
        "date": "2026-02-12",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": ["hsbc_vs"],
        "settings": {
          "red_hot_rewards_enabled": true,
          "red_hot_allocation": { "dining": 0, "world": 5, "home": 0, "enjoyment": 0, "style": 0 }
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "hsbc_vs",
        "topValue": 36,
        "breakdownFlags": { "hasLocked": false, "hasCapped": false, "hasPartial": false }
      }
    },
    {
      "id": "case_265_hsbc_pulse_overseas_other_fee_ranking",
      "input": {
        "amount": 1000,
        "category": "overseas_jp",
        "date": "2026-02-21",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": ["hsbc_red", "hsbc_pulse"],
        "settings": {
          "red_hot_rewards_enabled": false,
          "travel_guru_registered": false,
          "deduct_fcf_ranking": true
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "hsbc_pulse",
        "topValue": 4,
        "breakdownFlags": { "hasLocked": false, "hasCapped": false, "hasPartial": false }
      }
    },
    {
      "id": "case_266_hsbc_unionpay_std_mo_not_exempt",
      "input": {
        "amount": 1000,
        "category": "overseas_mo",
        "date": "2026-02-21",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": ["hsbc_unionpay_std", "hsbc_pulse"],
        "settings": {
          "red_hot_rewards_enabled": false,
          "travel_guru_registered": false,
          "deduct_fcf_ranking": true
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "hsbc_pulse",
        "topValue": 4,
        "breakdownFlags": { "hasLocked": false, "hasCapped": false, "hasPartial": false }
      }
    },
    {
      "id": "case_267_hsbc_unionpay_std_cn_fee_exempt_vs_hsbc_vs",
      "input": {
        "amount": 1000,
        "category": "overseas_cn",
        "date": "2026-02-21",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": ["hsbc_vs", "hsbc_unionpay_std"],
        "settings": {
          "red_hot_rewards_enabled": false,
          "travel_guru_registered": false,
          "deduct_fcf_ranking": true
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "hsbc_unionpay_std",
        "topValue": 4,
        "breakdownFlags": { "hasLocked": false, "hasCapped": false, "hasPartial": false }
      }
    },
    {
      "id": "case_268_hsbc_pulse_cn_fee_exempt_by_category_mapping",
      "input": {
        "amount": 1000,
        "category": "overseas_cn",
        "date": "2026-02-21",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "ownedCards": ["hsbc_vs", "hsbc_pulse"],
        "settings": {
          "red_hot_rewards_enabled": false,
          "travel_guru_registered": false,
          "deduct_fcf_ranking": true
        },
        "usage": {}
      },
      "expected": {
        "topCardId": "hsbc_pulse",
        "topValue": 4,
        "breakdownFlags": { "hasLocked": false, "hasCapped": false, "hasPartial": false }
      }
    },
    {
      "id": "case_269_sc_smart_hkticketing_within_window_designated",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-02-14",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "merchantId": "hkticketing",
        "ownedCards": ["sc_smart"],
        "settings": {},
        "usage": {
          "sc_smart_monthly_eligible": 5000,
          "sc_smart_cap": 0
        }
      },
      "expected": {
        "topCardId": "sc_smart",
        "topValue": 50,
        "breakdownFlags": { "hasLocked": true, "hasCapped": false, "hasPartial": false }
      }
    },
    {
      "id": "case_270_sc_smart_hkticketing_after_window_base_only",
      "input": {
        "amount": 1000,
        "category": "general",
        "date": "2026-02-15",
        "displayMode": "cash",
        "isOnline": false,
        "paymentMethod": "physical",
        "merchantId": "hkticketing",
        "ownedCards": ["sc_smart"],
        "settings": {},
        "usage": {
          "sc_smart_monthly_eligible": 5000,
          "sc_smart_cap": 0
        }
      },
      "expected": {
        "topCardId": "sc_smart",
        "topValue": 5.6,
        "breakdownFlags": { "hasLocked": true, "hasCapped": false, "hasPartial": false }
      }
    }
  ],
  "period_cases": [
    {
      "id": "period_001_month_start_day",
      "periodType": "month",
      "anchor": {
        "type": "month",
        "startDay": 20
      },
      "date": "2026-02-21",
      "prevBucketKey": "2026-01-20",
      "expectedBucketKey": "2026-02-20",
      "expectReset": true
    },
    {
      "id": "period_002_quarter_boundary",
      "periodType": "quarter",
      "anchor": {
        "type": "quarter",
        "startMonth": 1,
        "startDay": 1
      },
      "date": "2026-04-01",
      "prevBucketKey": "2026-01-01",
      "expectedBucketKey": "2026-04-01",
      "expectReset": true
    },
    {
      "id": "period_003_promo_end",
      "periodType": "promo",
      "anchor": {
        "type": "promo",
        "startDate": "2025-12-01",
        "endDate": "2026-02-01"
      },
      "promoId": "winter_promo",
      "date": "2026-02-02",
      "prevBucketKey": "promo:winter_promo@2025-12-01",
      "expectedBucketKey": "promo:winter_promo@2025-12-01:ended",
      "expectReset": true
    },
    {
      "id": "period_004_quarter_start_month_4",
      "periodType": "quarter",
      "anchor": {
        "type": "quarter",
        "startMonth": 4,
        "startDay": 1
      },
      "date": "2026-05-15",
      "prevBucketKey": "2026-01-01",
      "expectedBucketKey": "2026-04-01",
      "expectReset": true
    },
    {
      "id": "period_005_month_start_day_20_prev",
      "periodType": "month",
      "anchor": {
        "type": "month",
        "startDay": 20
      },
      "date": "2026-02-10",
      "prevBucketKey": "2026-01-20",
      "expectedBucketKey": "2026-01-20",
      "expectReset": false
    },
    {
      "id": "period_006_override_bucket_diff",
      "periodType": "month",
      "anchor": {
        "type": "month",
        "startDay": 5
      },
      "date": "2026-02-06",
      "prevBucketKey": "2026-02-01",
      "expectedBucketKey": "2026-02-05",
      "expectReset": true
    },
    {
      "id": "period_007_year_boundary",
      "periodType": "year",
      "anchor": {
        "type": "year",
        "startMonth": 1,
        "startDay": 1
      },
      "date": "2026-01-01",
      "prevBucketKey": "2025-01-01",
      "expectedBucketKey": "2026-01-01",
      "expectReset": true
    }
  ],
  "tx_cases": [
    {
      "id": "tx_001_txDate_used_for_valid_day_window",
      "ownedCards": [
        "dbs_compass"
      ],
      "settings": {},
      "cardId": "dbs_compass",
      "category": "grocery",
      "amount": 500,
      "isOnline": false,
      "paymentMethod": "physical",
      "txDate": "2026-05-27",
      "date": "2026-06-05T10:00:00.000Z",
      "expectedUsageKey": "dbs_compass_superwed_cap",
      "unexpectedUsageKey": "dbs_compass_com_bonus_cap",
      "expectedUsageValue": 500
    },
    {
      "id": "tx_002_em_threshold_only_tracks_overseas",
      "ownedCards": [
        "hsbc_everymile"
      ],
      "settings": {
        "em_promo_enabled": true
      },
      "cardId": "hsbc_everymile",
      "category": "general",
      "amount": 1000,
      "isOnline": false,
      "paymentMethod": "physical",
      "txDate": "2026-02-12",
      "date": "2026-02-12T10:00:00.000Z",
      "expectedUsageKey": "spend_hsbc_everymile",
      "unexpectedUsageKey": "em_q1_total",
      "expectedUsageValue": 1000
    }
  ]
}
